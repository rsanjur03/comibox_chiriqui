---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import AdminLoginPanel from '../components/AdminLoginPanel.astro';
---
<BaseLayout title="Login - COMIBOX Admin">
  <Header />
  <main class="container mx-auto p-4 md:p-8">
    <div id="panel-login">
      <AdminLoginPanel />
    </div>

    <script type="module">
      import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult } from 'firebase/auth';
      import { app } from '../lib/firebase.js';

      document.addEventListener('DOMContentLoaded', () => {
        const auth = getAuth(app);

        const panelLogin = document.getElementById('panel-login');
        const btnLogin = document.getElementById('btn-login-google');

        btnLogin?.addEventListener('click', async () => {
          const provider = new GoogleAuthProvider();
          try {
            await signInWithPopup(auth, provider);
          } catch (error) {
            console.error('Popup bloqueado o error al iniciar sesión. Intentando redirección...', error);
            try {
              await signInWithRedirect(auth, provider);
            } catch (e) {
              console.error('Error al redirigir para iniciar sesión:', e);
              alert('No se pudo iniciar sesión. Revisa el bloqueador de ventanas emergentes o intenta de nuevo.');
            }
          }
        });

        // Manejar resultados de redirección (por si la ventana emergente falla)
        getRedirectResult(auth).catch(err => console.warn('getRedirectResult error', err));

        onAuthStateChanged(auth, (user) => {
          if (user) {
            window.location.href = '/admin/boxeadores';
          } else {
            // usuario no autenticado: dejamos visible el panel de login
            if (panelLogin) panelLogin.style.display = 'block';
          }
        });
      });
    </script>
  </main>
  <Footer />
</BaseLayout>
