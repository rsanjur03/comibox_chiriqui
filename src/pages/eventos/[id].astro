---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

import { db } from "../../lib/firebase.js";
import {
  collection,
  getDocs,
  getDoc,
  doc,
  query,
  where,
  orderBy,
} from "firebase/firestore";

export async function getStaticPaths() {
  const eventosRef = collection(db, "eventos");
  const snapshot = await getDocs(eventosRef);
  const paths = snapshot.docs.map((d) => ({ params: { id: d.id } }));
  return paths;
}

const { id } = Astro.params;
const eventoRef = doc(db, "eventos", id);
const eventoSnap = await getDoc(eventoRef);
const evento = eventoSnap.data();

async function getPeleas(eventoId: string) {
  const peleasRef = collection(db, "peleas");
  const q = query(
    peleasRef,
    where("eventoId", "==", eventoId),
    orderBy("orden", "asc"),
  );
  const snapshot = await getDocs(q);
  return snapshot.docs.map((d) => d.data() as any);
}

const peleas = await getPeleas(id!);

// Fetch boxer photos
const boxerIds = new Set<string>();
peleas.forEach((p) => {
  if (p.boxeadorA_Id) boxerIds.add(p.boxeadorA_Id);
  if (p.boxeadorB_Id) boxerIds.add(p.boxeadorB_Id);
});

const boxerPhotos: Record<string, string> = {};
await Promise.all(
  Array.from(boxerIds).map(async (boxerId) => {
    try {
      const boxerSnap = await getDoc(doc(db, "boxeadores", boxerId));
      if (boxerSnap.exists()) {
        boxerPhotos[boxerId] = boxerSnap.data().fotoURL || "";
      }
    } catch (e) {
      console.error(`Error fetching boxer ${boxerId}`, e);
    }
  }),
);

// Precompute display fields to keep JSX simple
const peleasView = (peleas as any[]).map((p) => {
  const vKO_A =
    p.boxeadorA_victoriasKO > 0 ? `(${p.boxeadorA_victoriasKO})` : "";
  const dKO_A = p.boxeadorA_derrotasKO > 0 ? `(${p.boxeadorA_derrotasKO})` : "";
  const recordA = `${p.boxeadorA_Victorias || 0}${vKO_A}-${p.boxeadorA_Derrotas || 0}${dKO_A}-${p.boxeadorA_Empates || 0}`;

  const vKO_B =
    p.boxeadorB_victoriasKO > 0 ? `(${p.boxeadorB_victoriasKO})` : "";
  const dKO_B = p.boxeadorB_derrotasKO > 0 ? `(${p.boxeadorB_derrotasKO})` : "";
  const recordB = `${p.boxeadorB_Victorias || 0}${vKO_B}-${p.boxeadorB_Derrotas || 0}${dKO_B}-${p.boxeadorB_Empates || 0}`;

  const resultado =
    p.resultado_ganador && p.resultado_ganador !== "PENDIENTE"
      ? `Ganador: ${p.resultado_ganador} por ${p.resultado_metodo} (Ronda ${p.resultado_round})`
      : "Pelea Pendiente";
  const resultadoColor =
    p.resultado_ganador && p.resultado_ganador !== "PENDIENTE"
      ? "text-green-400 font-semibold"
      : "text-yellow-400";

  const pesoPactadoNum = parseFloat(p.pesoPactado) || Infinity;
  const pesoANum = parseFloat(p.boxeadorA_Peso) || 0;
  const pesoBNum = parseFloat(p.boxeadorB_Peso) || 0;
  const colorA =
    pesoANum > 0 && pesoANum <= pesoPactadoNum
      ? "text-green-400"
      : "text-red-400";
  const colorB =
    pesoBNum > 0 && pesoBNum <= pesoPactadoNum
      ? "text-green-400"
      : "text-red-400";
  const pesoA = p.boxeadorA_Peso > 0 ? `${p.boxeadorA_Peso} lbs` : "N/A";
  const pesoB = p.boxeadorB_Peso > 0 ? `${p.boxeadorB_Peso} lbs` : "N/A";

  return {
    ...p,
    recordA,
    recordB,
    resultado,
    resultadoColor,
    colorA,
    colorB,
    pesoA,
    pesoB,
    fotoA: boxerPhotos[p.boxeadorA_Id],
    fotoB: boxerPhotos[p.boxeadorB_Id],
  };
});
---

<BaseLayout title={`${evento?.nombre ?? "Evento"} - COMIBOX Chiriquí`}>
  <main class="container mx-auto p-4 md:p-8">
    <h1 class="text-4xl md:text-5xl font-extrabold text-white">
      {evento?.nombre ?? "Evento no encontrado"}
    </h1>
    <p class="text-xl text-gray-400 mb-8">
      {
        evento ? (
          <span>
            <span>{evento.fecha}</span>
            {evento.hora ? <span> ({evento.hora})</span> : null}
            <span>
              {" "}
              | {evento.lugar}
              {evento.ciudad ? `, ${evento.ciudad}` : ""}
              {evento.provincia ? `, ${evento.provincia}` : ""}
            </span>
          </span>
        ) : (
          "—"
        )
      }
    </p>

    <div class="border-b border-gray-700 mb-6">
      <nav class="-mb-px flex space-x-8" aria-label="Tabs">
        <button
          id="tab-detalles"
          class="tab-active text-blue-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg"
          >Detalles del Evento</button
        >
        <button
          id="tab-pesaje"
          class="text-gray-400 hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-lg"
          >Pesaje</button
        >
      </nav>
    </div>

    <div id="content-detalles" class="mt-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
        <div
          class="md:col-span-2 bg-gray-800 rounded-lg shadow-xl flex items-center justify-center p-4"
        >
          <div class="w-full h-auto max-h-[80vh] overflow-hidden">
            {
              evento?.flyerUrl ? (
                <img
                  src={evento.flyerUrl}
                  alt={`Flyer del Evento ${evento.nombre}`}
                  class="w-full h-auto object-contain block max-h-full"
                />
              ) : (
                <div class="h-96 w-full bg-gray-700 flex flex-col items-center justify-center text-gray-400 p-8 text-center rounded-lg">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-12 w-12 mb-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-2-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                    />
                  </svg>
                  <p class="text-xl">Flyer no disponible</p>
                </div>
              )
            }
          </div>
        </div>

        <div class="md:col-span-1">
          <h2
            class="text-2xl font-bold text-blue-400 mb-4 border-b border-gray-700 pb-2"
          >
            Detalles Clave
          </h2>
          <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
            <table class="w-full text-left text-sm text-gray-400">
              <tbody>
                <tr class="border-b border-gray-700"
                  ><td class="py-3 px-4 font-semibold text-gray-300">Fecha</td
                  ><td class="py-3 px-4 text-white">{evento?.fecha ?? "N/D"}</td
                  ></tr
                >
                <tr class="border-b border-gray-700"
                  ><td class="py-3 px-4 font-semibold text-gray-300">Hora</td
                  ><td class="py-3 px-4 text-white">{evento?.hora ?? "N/D"}</td
                  ></tr
                >
                <tr class="border-b border-gray-700"
                  ><td class="py-3 px-4 font-semibold text-gray-300">Lugar</td
                  ><td class="py-3 px-4 text-white">{evento?.lugar ?? "N/D"}</td
                  ></tr
                >
                <tr class="border-b border-gray-700"
                  ><td class="py-3 px-4 font-semibold text-gray-300">Ciudad</td
                  ><td class="py-3 px-4 text-white"
                    >{evento?.ciudad ?? "N/D"}</td
                  ></tr
                >
                <tr
                  ><td class="py-3 px-4 font-semibold text-gray-300"
                    >Promotor</td
                  ><td class="py-3 px-4 text-white"
                    >{evento?.promotor ?? "N/D"}</td
                  ></tr
                >
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <h2 class="text-3xl font-bold text-white mb-6">Cartelera de Peleas</h2>
      <ul id="lista-cartelera" class="space-y-6">
        {
          peleasView.length === 0 ? (
            <li class="text-gray-400">
              No hay peleas registradas para este evento.
            </li>
          ) : (
            peleasView.map((pelea) => (
              <li class="bg-gray-800 p-6 rounded-lg shadow-lg border-l-4 border-blue-600">
                <p class="text-sm text-gray-400 mb-2">
                  {pelea.roundsPactados} Rounds | {pelea.categoria} (
                  {pelea.pesoPactado || "N/A"})
                </p>
                <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-4">
                  {/* Boxeador A */}
                  <div class="flex items-center gap-4 flex-1 justify-end text-right">
                    <div>
                      <h3 class="text-2xl font-bold text-white">
                        {pelea.boxeadorA_Nombre}
                      </h3>
                      <span class="text-gray-400 font-normal block">
                        ({pelea.recordA})
                      </span>
                    </div>
                    {pelea.fotoA ? (
                      <img
                        src={pelea.fotoA}
                        alt={pelea.boxeadorA_Nombre}
                        class="w-16 h-16 rounded-full object-cover border-2 border-red-500"
                      />
                    ) : (
                      <div class="w-16 h-16 rounded-full bg-gray-700 border-2 border-red-500 flex items-center justify-center">
                        <span class="text-xs text-gray-500">Sin foto</span>
                      </div>
                    )}
                  </div>

                  <div class="text-2xl font-bold text-gray-500 px-4">VS</div>

                  {/* Boxeador B */}
                  <div class="flex items-center gap-4 flex-1 justify-start text-left">
                    {pelea.fotoB ? (
                      <img
                        src={pelea.fotoB}
                        alt={pelea.boxeadorB_Nombre}
                        class="w-16 h-16 rounded-full object-cover border-2 border-blue-500"
                      />
                    ) : (
                      <div class="w-16 h-16 rounded-full bg-gray-700 border-2 border-blue-500 flex items-center justify-center">
                        <span class="text-xs text-gray-500">Sin foto</span>
                      </div>
                    )}
                    <div>
                      <h3 class="text-2xl font-bold text-white">
                        {pelea.boxeadorB_Nombre}
                      </h3>
                      <span class="text-gray-400 font-normal block">
                        ({pelea.recordB})
                      </span>
                    </div>
                  </div>
                </div>

                <p class={`text-center text-lg ${pelea.resultadoColor}`}>
                  {pelea.resultado}
                </p>
              </li>
            ))
          )
        }
      </ul>
    </div>

    <div 
  id="content-pesaje" 
  class="mt-10 space-y-10 transition-opacity duration-500"
  style="display:none;"
>

  <!-- TÍTULO -->
  <div class="text-center">
    <h2 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">
      Resultados del Pesaje Oficial
    </h2>
    <p class="text-gray-400 mt-2">
      Comparación oficial de pesos | Control COMIBOX Chiriquí
    </p>
  </div>

  <!-- LISTA DE PELEAS -->
  <ul id="lista-pesaje" class="space-y-10">
    {
      peleasView.length === 0 ? (
        <li class="text-gray-400 text-center">
          No hay peleas registradas para este evento.
        </li>
      ) : (
        peleasView.map((pelea) => (
          <li class="bg-gradient-to-br from-gray-950 via-gray-900 to-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl border border-gray-700 hover:border-blue-500 transition">

            <!-- ENCABEZADO -->
            <div class="text-center mb-6">
              <h3 class="text-2xl md:text-3xl font-extrabold text-white">
                {pelea.boxeadorA_Nombre} 
                <span class="text-gray-400 mx-2">vs</span> 
                {pelea.boxeadorB_Nombre}
              </h3>
              <p class="text-sm text-gray-400 tracking-wide mt-1">
                {pelea.categoria} | {pelea.pesoPactado} lbs pactadas
              </p>
            </div>

            <!-- CONTENIDO -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">

              <!-- BLOQUE DE PESOS -->
              <div class="bg-gray-900 rounded-xl p-6 border border-gray-700 space-y-4 shadow-inner">

                <div class="flex justify-between items-center text-lg md:text-xl font-semibold">
                  <span class="text-gray-300">{pelea.boxeadorA_Nombre}</span>
                  <span class={`${pelea.colorA} font-extrabold`}>
                    {pelea.pesoA}
                  </span>
                </div>

                <div class="h-1 bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full"></div>

                <div class="flex justify-between items-center text-lg md:text-xl font-semibold">
                  <span class="text-gray-300">{pelea.boxeadorB_Nombre}</span>
                  <span class={`${pelea.colorB} font-extrabold`}>
                    {pelea.pesoB}
                  </span>
                </div>

              </div>

              <!-- FOTO CARA A CARA -->
              <div class="flex justify-center">
                {pelea.fotoCaraACaraURL ? (
                  <img
                    src={pelea.fotoCaraACaraURL}
                    alt="Foto Cara a Cara"
                    class="w-full max-w-[240px] sm:max-w-[280px] md:max-w-sm lg:max-w-md object-contain rounded-xl shadow-lg bg-black"
                  />
                ) : (
                  <div class="w-full max-w-lg h-56 rounded-xl flex flex-col items-center justify-center bg-gray-800 border-2 border-dashed border-gray-600">
                    <p class="text-gray-500 text-sm">Foto Cara a Cara</p>
                    <p class="text-gray-600 text-xs">No disponible</p>
                  </div>
                )}
              </div>

            </div>

            <!-- NOTA DE PESAJE -->
            {pelea.notasPesaje ? (
              <div class="mt-6 text-sm text-yellow-300 bg-black/40 p-4 rounded-xl border border-yellow-700 shadow">
                <strong class="text-yellow-400 block mb-1">
                  Nota Oficial de Pesaje:
                </strong>
                <p>{pelea.notasPesaje}</p>
              </div>
            ) : null}

          </li>
        ))
      )
    }
  </ul>
</div>


    <script>
      const tabDetalles = document.getElementById("tab-detalles");
      const tabPesaje = document.getElementById("tab-pesaje");
      const contentDetalles = document.getElementById("content-detalles");
      const contentPesaje = document.getElementById("content-pesaje");

      function setActive(tab: string) {
        if (tab === "detalles") {
          tabDetalles?.classList.add("tab-active", "text-blue-400");
          tabDetalles?.classList.remove(
            "text-gray-400",
            "hover:text-gray-300",
            "border-transparent",
          );
          tabPesaje?.classList.remove("tab-active", "text-blue-400");
          tabPesaje?.classList.add(
            "text-gray-400",
            "hover:text-gray-300",
            "border-transparent",
          );
          if (contentDetalles) contentDetalles.style.display = "block";
          if (contentPesaje) contentPesaje.style.display = "none";
        } else {
          tabPesaje?.classList.add("tab-active", "text-blue-400");
          tabPesaje?.classList.remove(
            "text-gray-400",
            "hover:text-gray-300",
            "border-transparent",
          );
          tabDetalles?.classList.remove("tab-active", "text-blue-400");
          tabDetalles?.classList.add(
            "text-gray-400",
            "hover:text-gray-300",
            "border-transparent",
          );
          if (contentDetalles) contentDetalles.style.display = "none";
          if (contentPesaje) contentPesaje.style.display = "block";
        }
      }

      tabDetalles?.addEventListener("click", () => setActive("detalles"));
      tabPesaje?.addEventListener("click", () => setActive("pesaje"));
    </script>
  </main>
</BaseLayout>
