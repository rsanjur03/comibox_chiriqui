---
export const prerender = false;

import BaseLayout from "../../layouts/BaseLayout.astro";
import LicenseCardBoxer from "../../components/LicenseCardBoxer.astro";
import LicenseCardBack from "../../components/LicenseCardBack.astro";

import { db } from "../../lib/firebase.js";
import {
  collection,
  getDocs,
  query,
  where,
  doc,
  getDoc,
} from "firebase/firestore";

const { evento } = Astro.params;

// ================================
// 1. OBTENER PELEAS DEL EVENTO
// ================================

const peleasRef = query(
  collection(db, "peleas"),
  where("eventoId", "==", evento)
);

const peleasSnap = await getDocs(peleasRef);
const peleasEvento = peleasSnap.docs.map((d) => d.data());

// ================================
// 2. BOXEADORES √öNICOS
// ================================

const idsBoxeadores = new Set();

peleasEvento.forEach((p) => {
  if (p.boxeadorA_Id) idsBoxeadores.add(p.boxeadorA_Id);
  if (p.boxeadorB_Id) idsBoxeadores.add(p.boxeadorB_Id);
});

const idsFinales = Array.from(idsBoxeadores);

// ================================
// 3. DATOS DE BOXEADORES
// ================================

const boxeadoresEvento = [];

for (const id of idsFinales) {
  const ref = doc(db, "boxeadores", id);
  const snap = await getDoc(ref);

  if (snap.exists()) {
    const data = snap.data();
    boxeadoresEvento.push({
      id,
      nombreLegal: data.nombreLegal,
      cedula: data.cedula,
      paisProcedencia: data.paisProcedencia,
      fechaNacimiento: data.fechaNacimiento,
      peso: data.peso || "--",
      fotoURL: data.fotoURL || "",
    });
  }
}

// ================================
// 4. LICENCIAS YA EXISTENTES (A√ëO)
// ================================

const anioActual = new Date().getFullYear();

const licenciasRef = query(
  collection(db, "licencias"),
  where("anio", "==", anioActual)
);

const licenciasSnap = await getDocs(licenciasRef);
const licenciasExistentes = licenciasSnap.docs.map((d) => d.data());

const idsConLicencia = licenciasExistentes.map((l) => l.boxeadorId);

// ================================
// 5. SOLO LOS QUE NO TIENEN LICENCIA
// ================================

const boxeadoresAGenerar = boxeadoresEvento.filter(
  (b) => !idsConLicencia.includes(b.id)
);

// ================================
// 6. NUMERACI√ìN AUTOM√ÅTICA
// ================================

let contadorLicencias = licenciasExistentes.length + 1;

function generarNumeroLicencia() {
  const num = String(contadorLicencias).padStart(4, "0");
  contadorLicencias++;
  return `CH-${anioActual}-${num}`;
}
---

<BaseLayout title={`Licencias Evento ${evento}`}>
  <main class="container mx-auto p-6">

    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-white">
        Generaci√≥n de Licencias ‚Äì Evento {evento}
      </h1>

      <button
        id="btn-exportar"
        class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-5 py-2 rounded shadow"
      >
        Exportar Frente + Reverso y Guardar
      </button>
    </div>

    <div class="bg-gray-800 p-4 rounded text-gray-200 mb-6">
      <p>‚úÖ Boxeadores en esta funci√≥n: <b>{boxeadoresEvento.length}</b></p>
      <p>‚úÖ Licencias ya emitidas este a√±o: <b>{idsConLicencia.length}</b></p>
      <p>üü° Carnets a generar ahora: <b>{boxeadoresAGenerar.length}</b></p>
    </div>

    {boxeadoresAGenerar.length === 0 ? (
      <div class="bg-green-700 text-white p-6 rounded text-center font-bold">
        ‚úÖ Todos los boxeadores ya tienen licencia vigente este a√±o.
      </div>
    ) : (
      <div class="grid gap-8" style="grid-template-columns: repeat(auto-fill, minmax(10cm, 1fr));">
        {boxeadoresAGenerar.map((b) => {
          const numero = generarNumeroLicencia();
          return (
            <div
              class="license-wrapper"
              data-boxeador-id={b.id}
              data-numero={numero}
              data-evento-id={evento}
            >
              <div class="flex gap-4 flex-wrap">
                <!-- FRENTE -->
                <LicenseCardBoxer
                  id={b.id}
                  nombreLegal={b.nombreLegal}
                  cedula={b.cedula}
                  paisProcedencia={b.paisProcedencia}
                  fechaNacimiento={b.fechaNacimiento}
                  peso={b.peso}
                  fotoURL={b.fotoURL}
                  numeroLicencia={numero}
                />

                <!-- REVERSO -->
                <LicenseCardBack
                  numeroLicencia={numero}
                  anio={anioActual}
                />
              </div>
            </div>
          );
        })}
      </div>
    )}
  </main>

  <!-- =============================================
       EXPORTAR FRENTE + REVERSO + GUARDAR EN FIRESTORE
       ============================================= -->
  <script type="module">
    import html2canvas from "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/+esm";
    import { db } from "/src/lib/firebase.js";
    import { collection, addDoc, serverTimestamp } from "firebase/firestore";

    const btn = document.getElementById("btn-exportar");

    btn?.addEventListener("click", async () => {
      btn.disabled = true;
      btn.innerText = "Procesando...";

      const wrappers = document.querySelectorAll(".license-wrapper");

      if (!wrappers.length) {
        alert("No hay carnets para exportar.");
        btn.disabled = false;
        btn.innerText = "Exportar Frente + Reverso y Guardar";
        return;
      }

      for (const wrap of wrappers) {
        try {
          const cardFront = wrap.querySelector(".license-card");
          const cardBack = wrap.querySelector(".license-card-back");

          const boxeadorId = wrap.dataset.boxeadorId;
          const numeroLicencia = wrap.dataset.numero;
          const eventoId = wrap.dataset.eventoId;

          /* ===== FRENTE ===== */
          const canvasFront = await html2canvas(cardFront, {
            scale: 3,
            useCORS: true,
            backgroundColor: "#ffffff"
          });

          const linkFront = document.createElement("a");
          linkFront.download = `licencia-${numeroLicencia}-frente.png`;
          linkFront.href = canvasFront.toDataURL("image/png");
          linkFront.click();

          /* ===== REVERSO ===== */
          const canvasBack = await html2canvas(cardBack, {
            scale: 3,
            useCORS: true,
            backgroundColor: "#ffffff"
          });

          const linkBack = document.createElement("a");
          linkBack.download = `licencia-${numeroLicencia}-reverso.png`;
          linkBack.href = canvasBack.toDataURL("image/png");
          linkBack.click();

          /* ===== GUARDAR EN FIRESTORE ===== */
          await addDoc(collection(db, "licencias"), {
            boxeadorId,
            anio: new Date().getFullYear(),
            numeroLicencia,
            eventoId,
            fechaGeneracion: serverTimestamp()
          });

        } catch (err) {
          console.error("Error exportando licencia:", err);
        }
      }

      alert("‚úÖ Frentes y reversos exportados y guardados correctamente.");
      btn.disabled = false;
      btn.innerText = "Exportar Frente + Reverso y Guardar";
    });
  </script>

</BaseLayout>
